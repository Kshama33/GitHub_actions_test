name: Upload Power BI Reports

on:
  push:
    branches:
      - main

jobs:
  upload_reports:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install PyYAML
        run: |
          python -m pip install pyyaml

      - name: Read release.yml and extract names
        id: extract_names
        run: |
          python -c "
          import yaml
          import os
          with open('release.yml', 'r') as file:
              data = yaml.safe_load(file)
              names = [item['name'] for item in data['list']]
              names_str = ','.join(names)
              with open(os.environ['GITHUB_ENV'], 'a') as env_file:
                  env_file.write(f'names={names_str}\n')
              "

        shell: bash

      - name: Find matching PBIX and RDL files
        id: find_files
        run: |
          names=${{ steps.extract_names.outputs.names }}
          files=$(find dev/release -type f \( -name "*.pbix" -o -name "*.rdl" \))
          matched_files=()
          for file in $files; do
              for name in ${names//,/ }; do
                  if [[ $file == *"$name"* ]]; then
                      matched_files+=("$file")
                      break
                  fi
              done
          done
          echo "::set-output name=matched_files::${matched_files[*]}"
          
